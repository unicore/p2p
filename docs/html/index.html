<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>P2P: P2P</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">P2P
   </div>
   <div id="projectbrief">смарт-контакт</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">P2P </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a class="anchor" id="md_README"></a></p><h2>Стек: C/C++, eosio.cdt 1.7.0</h2>
<h1>Введение</h1>
<p >Контракт обеспечивает обмен токенами между двумя пользователями системы с участием гаранта. Создавая ордер типа sell, токены продавца блокируются в контракте и передаются покупателю после подтверждения завершения сделки.</p>
<p >Каждый ордер, не обладающий родителем, готов принимать предложения о сделках в дочерних ордерах противоположного типа. Так, если родительский ордер типа buy, то он готов принимать предложения от ордеров с типом sell, и наоборот. Обмен производится по курсу относительно системной опорной валюты (USD).</p>
<p >В процессе обмена всегда задействованы три типа валют:</p><ul>
<li>root_asset - токен обмена, который предоставляет продавец для блокировки в контракте и получает покупатель после завершения сделки.</li>
<li>quote_asset - опорный токен, который используется для расчёта количества валюты выхода.</li>
<li>out_asset - токен выхода, который получает продавец и отправляет покупатель на реквизиты продавца.</li>
</ul>
<h1>Применение</h1>
<p >Контракт может использоваться:</p><ul>
<li>как <a class="el" href="classp2p.html" title="Начните ознакомление здесь.">p2p</a> биржа обмена любым стандартным заменяемым цифровым активом;</li>
<li>как точка реализации токена компанией (IDO), которая не исключает возможность перепродаж токенов пользователями;</li>
<li>как касса взаимопомощи, где только те пользователи могут получить валюту выхода на свои реквизиты, которые обладают токенами обмена; Во всех вариантах каждый хост цифровой экономики на аккаунте _core может создать дополнительный стимул на продаже собственных токенов, активировав партнёрскую программу. Для этого, он должен пополнить бонусный баланс контракта и установить бонусный курс, который будет использоваться при расчёте вознаграждений по структуре покупателя по формуле: <div class="fragment"><div class="line">КОЛИЧЕСТВО_ТОКЕНОВ_ПАРТНЁРАМ_ПОКУПАТЕЛЯ = КОЛИЧЕСТВО_ТОКЕНОВ_В_УСПЕШНОЙ_СДЕЛКЕ_У_ПРОДАВЦА * БОНУСНЫЙ_КУРС_ПРОДАВЦА</div>
</div><!-- fragment --></li>
</ul>
<h1>Действующие аккаунты</h1>
<p >me - собственное имя контракта; curator - дефолтный оракул, используемый во всех сделках; rater - имя аккаунта поставщика курсов обмена; core - имя аккаунта, распределяющего партнерское вознаграждение;</p>
<h1>Основные управляющие параметры</h1>
<p >ENABLE_GROWHT = TRUE - допускает изменение курса системного токена в процентном соотношении от стартового курса (линейный рост) START_RATE - стартовый курс системного токена, используемый при расчёте линейного роста; PERCENTS_PER_MONTH - устанавливает скорость роста системного токена; ENABLE_VESTING - включает режим продаж через вестинг равными долями от момента создания объекта; VESTING_SECONDS - продолжительность вестинга; CORE_SALE_ACCOUNT - аккаунт компании, осуществляющий IDO, продажа от которого проходит с применением вестинга. Все остальные аккаунты совершают сделки без вестинга; GIFT_ACCOUNT_FROM_AMOUNT - если покупка совершается у компании на сумму, превышающую в этом поле, то компания совершает выкуп прав владельца аккаунта у регистратора и передаёт их пользователю (переводит аккаунт из статуса гость в статус партнёр).</p>
<h1>Компиляция</h1>
<p >Заменить ABSOLUTE_PATH_TO_CONTRACT на абсолютный путь к директории контракта <a class="el" href="classp2p.html" title="Начните ознакомление здесь.">p2p</a>. </p><div class="fragment"><div class="line">docker run --rm --name eosio.cdt_v1.7.0 --volume /ABSOLUTE_PATH_TO_CONTRACT:/project -w /project eostudio/eosio.cdt:v1.7.0 /bin/bash -c &quot;eosio-cpp -abigen -I include -R include -contract p2p -o p2p.wasm p2p.cpp&quot; &amp;</div>
</div><!-- fragment --><h1>Роли</h1>
<ul>
<li>Продавец - создаёт ордер типа sell</li>
<li>Покупатель - создаёт ордер типа buy</li>
<li>Оракул - разрешает споры между партнёрами</li>
<li>Поставщик курса - поставляет курс валют выхода</li>
<li>Системный поставщик курса - поставляет курс системной валюты</li>
</ul>
<h1>Сценарии</h1>
<h3>Пополнение собственного баланса</h3>
<p >Для того, чтобы иметь возможность создать ордер на продажу, необходимо обладать балансом на контракте. Для этого, необходимо совершить перевод на имя аккаунта контракта без дополнительных параметров в поле memo: </p><div class="fragment"><div class="line">cleos transfer username p2p &quot;100.0000 FLOWER&quot;</div>
</div><!-- fragment --><p> Проверить собственный баланс с помощью команды: </p><div class="fragment"><div class="line">cleos get table p2p username balance</div>
</div><!-- fragment --><p> Ответ содержит имя контракта и количество токенов, доступных к сделке продажи: </p><div class="fragment"><div class="line">&quot;rows&quot;: [{</div>
<div class="line">      &quot;id&quot;: 0,</div>
<div class="line">      &quot;contract&quot;: &quot;eosio.token&quot;,</div>
<div class="line">      &quot;quantity&quot;: &quot;100.0000 FLOWER&quot;</div>
<div class="line">    }</div>
<div class="line">  ],</div>
</div><!-- fragment --><h3>Пополнение бонусного баланса</h3>
<p >Для пополнения бонусного баланса необходимо совершить перевод на собственное имя аккаунта контракта с указанием в поле memo имени аккаунта, который активирует бонусную систему. Бонусная система доступна только хостам цифровых экономик в контракте core. Аккаунты, не обладающие статусом хоста в контракте core не смогут распределить бонусные токены на структуру покупателя.</p>
<div class="fragment"><div class="line">cleos transfer username p2p &quot;100.0000 FLOWER&quot; &quot;username&quot;</div>
</div><!-- fragment --><p >Проверить бонусный баланс с помощью команды: </p><div class="fragment"><div class="line">cleos get table p2p p2p bbonuses</div>
</div><!-- fragment --><p> Ответ содержит имена аккаунтов хостов и их бонусные балансы: </p><div class="fragment"><div class="line">&quot;rows&quot;: [{</div>
<div class="line">      &quot;host&quot;: &quot;alexant&quot;,</div>
<div class="line">      &quot;contract&quot;: &quot;eosio.token&quot;,</div>
<div class="line">      &quot;total&quot;: &quot;200.0000 FLOWER&quot;,</div>
<div class="line">      &quot;available&quot;: &quot;200.0000 FLOWER&quot;,</div>
<div class="line">      &quot;distributed&quot;: &quot;0.0000 FLOWER&quot;,</div>
<div class="line">      &quot;distribution_rate&quot;: &quot;0.00000000000000000&quot;</div>
<div class="line">    },{</div>
<div class="line">      &quot;host&quot;: &quot;core&quot;,</div>
<div class="line">      &quot;contract&quot;: &quot;eosio.token&quot;,</div>
<div class="line">      &quot;total&quot;: &quot;10000.0000 FLOWER&quot;,</div>
<div class="line">      &quot;available&quot;: &quot;9900.0000 FLOWER&quot;,</div>
<div class="line">      &quot;distributed&quot;: &quot;100.0000 FLOWER&quot;,</div>
<div class="line">      &quot;distribution_rate&quot;: &quot;1.00000000000000000&quot;</div>
<div class="line">    }</div>
<div class="line">  ],</div>
</div><!-- fragment --><p> При повторном пополнении бонусного баланса, соответствующие токены суммируются.</p>
<h3>Активация бонусной системы</h3>
<p >Для активации бонусной системы, аккаунт должен обладать статусом активного хоста в контракте core с установленными параметрами распределения по уровням пользователей. Для того, чтобы в момент продажи бонусные токены распределились среди партнёров покупателя, необходимо установить бонусный курс распределения: </p><div class="fragment"><div class="line">cleos push action p2p setbrate &#39;[username, 1]&#39; -p username </div>
</div><!-- fragment --><p> Где 1 - это бонусный курс, который распределяет на партнёров покупателя в точности ту сумму (если она доступна в бонусном балансе хоста), которая находилась в сделке. При установке 0 - распределение бонусных токенов останавливается.</p>
<h3>Продажа</h3>
<p >Создавая ордер на продажу, продавец указывает валюту выхода, которую намерен получить от покупателя и курс к опорной валюте (USD), по которому готов осуществить продажу, а также реквизиты для получения валюты выхода. В момент создания ордера на продажу, контракт блокирует токены продавца, после чего, вывести их из блокировки можно только в случае отмены ордера (метод cancel), завершения сделки (метод approve), или разрешения открытого спора. После создания ордера, продавец ожидает встречного ордера от покупателя.</p>
<p >Покупатель создаёт встречный ордер, фиксируя курс валюты выхода на этот момент. После получения встречного ордера, продавец должен подтвердить своё присутствие и условия обмена. Встречный курс обмена в дочернем ордере может отличаться от того, что был заявлен продавцом.</p>
<p >Если встречные условия продавца устраивают, то он подтверждает начало сделки методом accept с передачей зашифрованных реквизитов для перевода валюты выхода покупателю. После вызова метода accept продавцом, статус дочернего ордера меняется на process. Статус родительского ордера продавца находится в waiting и не изменяется до момента полной реализации токенов.</p>
<p >Теперь, покупатель должен осуществить перевод валюты выхода на реквизиты продавца. Совершив перевод, продавец подтверждает факт отправки средств вызовом метода confirm с указанием идентификатора своего ордера, что меняет статус ордера на payed. Теперь, продавец должен подтвердить факт получения валюты выхода на свои реквизиты, вызовом метода approve с указанием идентификатором встречного ордера. При получении транзакции с действием approve от продавца, происходит разблокировка токенов обмена в пользу покупателя.</p>
<h3>Покупка</h3>
<p >Создавая ордер на покупку, покупатель указывает валюту выхода, которую намер получить от продавца и курс к опорной валюте (USD), по которому готов осуществить покупку. После создания ордера на покупку, покупатель ожидает появления встречного ордера от продавца.</p>
<p >Продавец создаёт встречный ордер, фиксируя курс валюты выхода на этот момент и передаёт зашифрованные реквизиты покупателю. Контракт, при этом, блокирует его токены обмена до момента завершения сделки (метод approve), отмены (метод cancel) или разрешения открытого спора.</p>
<p >Если встречные условия устраивают покупателя, то он подтверждает начало сделки методом accept, после чего, статус дочернего ордера меняется на process. Статус родительского ордера покупателя находится в waiting и не изменяется до момента реализации токенов.</p>
<p >Теперь, покупатель должен осуществить передачу валюты выхода на реквизиты, предоставленные продавцом. После передачи, покупатель подтверждает этот факт вызовом метода confirm, а дочерний ордер переходит в статус payed, статус родительского ордера при этом не изменяется.</p>
<p >После получения оплаты в валюте выхода на свои реквизиты, покупатель должен вызвать метод approve с указанием идентификатора встречного ордера. При получении транзакции с подтверждением о получении валюты выхода от продавца, контракт разблокирует токены обмена в пользу покупателя.</p>
<h3>Разрешение споров</h3>
<p >TODO реализовать метод и логику разрешения споров.</p>
<h3>Частичный обмен</h3>
<p >Количество токенов на обмене, которые хочет получить покупатель, могут отличаться в меньшую сторону от заявки продавца. В этом случае, произойдёт срабатывание ордера только на сумму обмена, а остаток останется в ордере продавца для обмена с другими покупателями.</p>
<h3>Обновление опорных курсов</h3>
<p >Контракт содержит опорные курсы конвертации валют выхода к опорной валюте (USD), которые поставляются специальным аккаунтом поставщика из внешних источников (rater).</p>
<div class="fragment"><div class="line">cleos push action p2p setrate &#39;[&quot;&quot;, &quot;0.0000 RUB&quot;, 0.0133]&#39; -p rater</div>
</div><!-- fragment --><p> Для получения курсов валют выхода вызываем команду: </p><div class="fragment"><div class="line">cleos get table p2p p2p usdrates</div>
</div><!-- fragment --><p> В ответе увидим: </p><div class="fragment"><div class="line">&quot;rows&quot;: [{</div>
<div class="line">      &quot;id&quot;: 0,</div>
<div class="line">      &quot;out_contract&quot;: &quot;&quot;,</div>
<div class="line">      &quot;out_asset&quot;: &quot;0.0000 RUB&quot;,</div>
<div class="line">      &quot;rate&quot;: &quot;0.01330000000000000&quot;,</div>
<div class="line">      &quot;updated_at&quot;: &quot;2021-12-30T13:34:31&quot;</div>
<div class="line">    }]</div>
</div><!-- fragment --><p> Где 0.0133 - это курс RUB / USD, что соответствует 75,1879 USD / RUB. ВАЖНО! Обращаем внимание, что курсы поставляются в базе к USD, что часто соответствует обратным значением к тем, которые привычны.</p>
<p >TODO На текущий момент, поставщик курсов один, в дальнейшем реализовать скользящую среднюю курсов на 14 дней от 21 делегата.</p>
<h3>Обновление курса системного токена</h3>
<p >Обновление курс системного токена производится системным аккаунтом eosio раз в минуту, если этот режим активирован с его стороны. В любом случае, для того, чтобы изменить курс реализации системного токена на продаже, необходимо вызвать метод uprate: </p><div class="fragment"><div class="line">cleos push action p2p uprate &#39;[&quot;eosio.token&quot;, &quot;0.0000 FLOWER&quot;]&#39; -p eosio</div>
</div><!-- fragment --><p> Расчёт изменений курса будет отображен в таблице usdrates. Курс обмена увеличится на линейную величину в соотстветствии с процентом роста PERCENTS_PER_MONTH и стартовым курсом START_RATE.</p>
<p >Системный курс используется в веб-терминале при активированном режиме продаж системного токена, что отключает для пользователей визуальную возможность редактирования курса обмена, а все обмены производятся по установленному системному курсу на момент получения встречного ордера.</p>
<h3>Шифрование реквизитов</h3>
<p >Реквизиты передаются через блокчейн в зашифрованном виде по протоколу Диффи-Хеллмана, при котором, шифрование происходит с участием приватного ключа отправителя и публичного ключа получателя. Таким образом, только им двоим доступны зашифрованные реквизиты, поскольку расшифровка доступна как с помощью приватного ключа отправителя, так и с помощью приватного ключа получателя.</p>
<h3>Документация к методам и таблицам контракта</h3>
<p >Документация к методам и таблицам контракта доступна в папке docs/html/index.html </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
